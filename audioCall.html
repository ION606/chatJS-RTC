<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioCallTest</title>

    <!-- this contains DUPLICATES from the chatJS repo -->
    <script>
        function createWSPath() {
            const socketProtocol = (window.location.protocol === 'https:' ? 'wss:' : 'ws:')
            var echoSocketUrl = socketProtocol + `//${window.location.hostname}`;
            if (window.location.port) echoSocketUrl += `4000`; //window.location.port
            echoSocketUrl += '/websocket';
            return echoSocketUrl;
        }
    </script>

    <script>
        async function getInputDevice(ws) {
            const useVideo = document.getElementById('addVideo').checked;
            const useAudio = document.getElementById('addAudio').checked;

            // Get access to the local camera and microphone
            try {
                var stream;
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: useVideo, audio: useAudio });
                } catch (err) {
                    if (err.message == 'TypeError: audio and/or video is required') return;
                    console.error(err);
                    return;
                }


                // Display the local video stream
                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = stream;

                // Create a PeerConnection object
                const configuration = {
                    iceServers: [
                        { urls: 'turn:127.0.0.1:3478', username: "username", credential: "password" },
                        // { urls: 'stun:stun.example.com:3478' },
                        // { urls: 'turn:turn.example.com:3478', username: 'yourUsername', credential: 'yourPassword' } // TURN server with credentials
                    ]
                };
                const peerConnection = new RTCPeerConnection(configuration);

                // Add the local stream to the peer connection
                stream.getTracks().forEach(function (track) {
                    peerConnection.addTrack(track, stream);
                });

                // Handle incoming data from the remote peer
                peerConnection.ondatachannel = function (event) {
                    var dataChannel = event.channel;
                    dataChannel.onmessage = function (event) {
                        // Handle incoming data
                    };
                };

                // Create an offer and send it to the server for forwarding
                peerConnection.createOffer()
                    .then(function (offer) {
                        return peerConnection.setLocalDescription(offer);
                    })
                    .then(function () {
                        // Send the offer to the server for forwarding
                        console.log(ws);
                        ws.send(JSON.stringify({ offer: peerConnection.localDescription }));
                    })
                    .catch(function (error) {
                        console.error('Error creating offer:', error);
                    });

                // Handle incoming offers and answers from the remote peer

                // Implement hang-up functionality
                const hangupButton = document.getElementById('hangupButton');
                hangupButton.addEventListener('click', function () {
                    // Close the connection and clean up resources
                    peerConnection.close();
                    // Signal the hang-up to the remote peer
                    ws.send(JSON.stringify({ hangup: true }));
                });
            }
            catch (err) {
                console.error('Error accessing camera and microphone:', err);
                alert("An error occurred!");
                // Add code to close the call or handle the error later
            }
        }

        window.addEventListener('DOMContentLoaded', function () {
            const ws = new WebSocket('ws://localhost:3000'); // Use the correct WebSocket URL
            ws.addEventListener('open', (event) => {
                // Connection opened successfully
                console.log("WEBSOCKET SERVER OPEN");
            });
            ws.addEventListener('message', (event) => {
                // Handle incoming messages
                console.log("GOT MESSAGE:");
                console.log(event);
            });
            ws.addEventListener('error', (event) => {
                // Handle WebSocket errors
                console.error(event);
            });
            ws.addEventListener('close', (event) => {
                // Handle WebSocket closure\
                console.log("WEBSOCKET SERVER CLOSED");
            });


            setInterval(() => { ws.send(JSON.stringify({ code: 10 })); }, 30000);
            const useVideo = document.getElementById('addVideo').addEventListener('change', () => window.location.reload());
            const useAudio = document.getElementById('addAudio').addEventListener('change', () => window.location.reload());
            getInputDevice(ws);
        });
    </script>
</head>

<body>
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
    <input type="checkbox" id="addVideo">
    <input type="checkbox" id="addAudio">
    <button id="startButton">Start Call</button>
    <button id="hangupButton">Hang Up</button>
</body>

</html>
